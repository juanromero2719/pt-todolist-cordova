<ion-header translucent="true" class="pt-header">
  <ion-toolbar>
    <ion-title>To-Do</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content fullscreen="true" class="pt-content">
  <div class="ion-padding pt-container">

    <!-- Form Card -->
    <ion-card class="pt-card">
      <ion-card-header>
        <ion-card-title>Crear tarea</ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <form [formGroup]="form" (ngSubmit)="addTask()" class="pt-form">
          <ion-item lines="none" class="pt-item">
            <ion-icon name="create-outline" slot="start" class="pt-icon"></ion-icon>
            <ion-input
              label="Tarea"
              labelPlacement="stacked"
              placeholder="Ej: Comprar leche"
              formControlName="title"
              clearInput="true">
            </ion-input>
          </ion-item>

          <!-- Category input (feature flag) -->
          <ion-item
            *ngIf="(flags.enableCategories$ | async) === true"
            lines="none"
            class="pt-item">
            <ion-icon name="pricetag-outline" slot="start" class="pt-icon"></ion-icon>
            <ion-input
              label="CategorÃ­a"
              labelPlacement="stacked"
              placeholder="Ej: work, home"
              formControlName="category"
              clearInput="true">
            </ion-input>
          </ion-item>

          <ion-button
            expand="block"
            shape="round"
            type="submit"
            class="pt-primary-btn"
            [disabled]="form.invalid">
            <ion-icon name="add-circle-outline" slot="start"></ion-icon>
            Agregar
          </ion-button>
        </form>
      </ion-card-content>
    </ion-card>

    <!-- Filter Card (feature flag: categories) -->
    <ion-card
      *ngIf="(flags.enableCategories$ | async) === true"
      class="pt-card pt-filter-card">
      <ion-card-content>
        <ion-item lines="none" class="pt-item pt-filter-item">
          <ion-icon name="funnel-outline" slot="start" class="pt-icon"></ion-icon>

          <ion-label class="pt-filter-label">Filtrar</ion-label>

          <ion-select
            class="pt-select"
            interface="popover"
            [value]="(selectedCategory$ | async) ?? ''"
            (ionChange)="filter($event.detail.value || null)">
            <ion-select-option value="">Todas</ion-select-option>
            <ion-select-option *ngFor="let c of (categories$ | async)" [value]="c">
              {{ c }}
            </ion-select-option>
          </ion-select>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <!-- Empty state -->
    <ion-card class="pt-card" *ngIf="(tasks$ | async)?.length === 0">
      <ion-card-content>
        <div class="pt-empty">
          <ion-icon name="sparkles-outline" class="pt-empty-icon"></ion-icon>
          <div>
            <div class="pt-empty-title">No tienes tareas todavÃ­a</div>
            <div class="pt-empty-sub">Crea tu primera tarea arriba ğŸ™‚</div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Tasks -->
    <ion-list lines="none" class="pt-list">
      <ion-item
        *ngFor="let t of (tasks$ | async); trackBy: trackByTaskId"
        class="pt-task"
        [class.pt-task-removing]="isRemoving(t.id)"
        [class.pt-task-completed]="t.status === 'done'"
        detail="false">

        <!-- Complete toggle (feature flag) -->
        <ion-checkbox
          slot="start"
          class="pt-checkbox"
          [checked]="t.status === 'done'"
          [disabled]="(flags.enableComplete$ | async) === false"
          (ionChange)="toggle(t.id)">
        </ion-checkbox>

        <ion-label class="pt-task-label">
          <div class="pt-task-title" [class.pt-done]="t.status === 'done'">
            {{ t.title }}
          </div>

          <div class="pt-meta">
            <!-- Category chip (feature flag) -->
            <ion-chip *ngIf="(flags.enableCategories$ | async) === true" class="pt-chip" outline="true">
              <ion-icon name="pricetag-outline"></ion-icon>
              <ion-label>{{ t.category }}</ion-label>
            </ion-chip>

            <ion-badge class="pt-badge" [color]="t.status === 'done' ? 'success' : 'medium'">
              {{ t.status === 'done' ? 'Completada' : 'Pendiente' }}
            </ion-badge>
          </div>
        </ion-label>

        <!-- Delete button (feature flag) -->
        <ion-button
          *ngIf="(flags.enableDelete$ | async) === true"
          slot="end"
          fill="clear"
          color="danger"
          class="pt-trash"
          (click)="remove(t.id)">
          <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
        </ion-button>

      </ion-item>
    </ion-list>

  </div>
</ion-content>
